import{_ as q,r as c,h as V,a as u,o as C,c as T,b as l,w as t,e as y,F as A,i as _,l as K,d as w,E as f,f as M,x as S}from"./index.8925aaca.js";import{a as $}from"./axios.3a665b0f.js";const H={class:"consume-card"},P={class:"result-content"},j={__name:"ConsumeCard",setup(z){const b=c(null),v=c(!1),m=c(!1),o=c(null),r=V({success:!1,title:"",subTitle:""}),a=V({studentId:"",consumeType:"",amount:0,description:""}),N=V({studentId:[{required:!0,message:"请输入学生ID",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],consumeType:[{required:!0,message:"请选择消费类型",trigger:"change"}],amount:[{required:!0,message:"请输入消费金额",trigger:"blur"},{type:"number",min:.01,message:"金额必须大于0",trigger:"blur"}],description:[{max:200,message:"描述不能超过200个字符",trigger:"blur"}]}),U=async()=>{if(a.studentId)try{const s=await $.get(`http://localhost:8080/api/v1/cards/${a.studentId}`);o.value=s,s.status!=="ACTIVE"&&(f.warning("该校园卡已注销，无法进行消费"),o.value=null)}catch(s){o.value=null,f.error(s.message||"获取校园卡信息失败")}},k=async s=>{s&&await s.validate(async e=>{if(e){if(!o.value){f.warning("请先输入有效的学生ID");return}if(a.amount>o.value.balance){f.warning("余额不足");return}try{v.value=!0;const d=await $.put(`http://localhost:8080/api/v1/cards/${a.studentId}/balance`,{amount:-a.amount});r.success=!0,r.title="消费成功",r.subTitle=`已成功从学生ID为 ${a.studentId} 的校园卡扣除 ¥${a.amount}`,m.value=!0,I(s),o.value=null}catch(d){r.success=!1,r.title="消费失败",r.subTitle=d.message||"请检查卡片状态或余额是否充足",m.value=!0}finally{v.value=!1}}})},I=s=>{s&&(s.resetFields(),o.value=null)};return(s,e)=>{const d=u("el-input"),i=u("el-form-item"),p=u("el-option"),E=u("el-select"),R=u("el-input-number"),x=u("el-icon"),g=u("el-button"),B=u("el-form"),D=u("el-card"),F=u("el-result"),O=u("el-dialog");return C(),T("div",H,[l(D,{class:"card-container"},{header:t(()=>e[10]||(e[10]=[y("div",{class:"card-header"},[y("h3",null,"校园卡消费")],-1)])),default:t(()=>[l(B,{ref_key:"formRef",ref:b,model:a,rules:N,"label-width":"120px","label-position":"right","status-icon":""},{default:t(()=>[l(i,{label:"学生ID",prop:"studentId"},{default:t(()=>[l(d,{modelValue:a.studentId,"onUpdate:modelValue":e[0]||(e[0]=n=>a.studentId=n),placeholder:"请输入学生ID",clearable:"",onBlur:U},null,8,["modelValue"])]),_:1}),o.value?(C(),T(A,{key:0},[l(i,{label:"学生姓名"},{default:t(()=>[l(d,{modelValue:o.value.studentName,"onUpdate:modelValue":e[1]||(e[1]=n=>o.value.studentName=n),disabled:""},null,8,["modelValue"])]),_:1}),l(i,{label:"当前余额"},{default:t(()=>[l(d,{modelValue:o.value.balance,"onUpdate:modelValue":e[2]||(e[2]=n=>o.value.balance=n),disabled:""},{prepend:t(()=>e[11]||(e[11]=[_("¥")])),_:1},8,["modelValue"])]),_:1})],64)):K("",!0),l(i,{label:"消费类型",prop:"consumeType"},{default:t(()=>[l(E,{modelValue:a.consumeType,"onUpdate:modelValue":e[3]||(e[3]=n=>a.consumeType=n),placeholder:"请选择消费类型",style:{width:"100%"}},{default:t(()=>[l(p,{label:"食堂就餐",value:"CANTEEN"}),l(p,{label:"超市购物",value:"SUPERMARKET"}),l(p,{label:"图书文具",value:"BOOKSTORE"}),l(p,{label:"其他",value:"OTHER"})]),_:1},8,["modelValue"])]),_:1}),l(i,{label:"消费金额",prop:"amount"},{default:t(()=>[l(R,{modelValue:a.amount,"onUpdate:modelValue":e[4]||(e[4]=n=>a.amount=n),min:.01,max:o.value?o.value.balance:9999,precision:2,step:1,style:{width:"100%"}},null,8,["modelValue","max"])]),_:1}),l(i,{label:"消费说明",prop:"description"},{default:t(()=>[l(d,{modelValue:a.description,"onUpdate:modelValue":e[5]||(e[5]=n=>a.description=n),type:"textarea",rows:2,placeholder:"请输入消费说明（选填）"},null,8,["modelValue"])]),_:1}),l(i,null,{default:t(()=>[l(g,{type:"primary",onClick:e[6]||(e[6]=n=>k(b.value)),loading:v.value},{default:t(()=>[l(x,null,{default:t(()=>[l(w(M))]),_:1}),e[12]||(e[12]=_("确认消费 "))]),_:1,__:[12]},8,["loading"]),l(g,{onClick:e[7]||(e[7]=n=>I(b.value))},{default:t(()=>[l(x,null,{default:t(()=>[l(w(S))]),_:1}),e[13]||(e[13]=_("重置 "))]),_:1,__:[13]})]),_:1})]),_:1},8,["model","rules"])]),_:1}),l(O,{modelValue:m.value,"onUpdate:modelValue":e[9]||(e[9]=n=>m.value=n),title:"消费结果",width:"30%",center:""},{default:t(()=>[y("div",P,[l(F,{icon:r.success?"success":"error",title:r.title,"sub-title":r.subTitle},{extra:t(()=>[l(g,{type:"primary",onClick:e[8]||(e[8]=n=>m.value=!1)},{default:t(()=>e[14]||(e[14]=[_("确定")])),_:1,__:[14]})]),_:1},8,["icon","title","sub-title"])])]),_:1},8,["modelValue"])])}}},L=q(j,[["__scopeId","data-v-cbf9cb8e"]]);export{L as default};
