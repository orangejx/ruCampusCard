import{_ as O,r as c,h as V,a as u,o as T,c as x,b as l,w as t,e as y,F as q,i as _,l as S,d as w,E as f,f as K,x as M}from"./index.29217557.js";import{c as N}from"./card.787f49f5.js";const H={class:"consume-card"},P={class:"result-content"},j={__name:"ConsumeCard",setup(z){const v=c(null),b=c(!1),m=c(!1),o=c(null),r=V({success:!1,title:"",subTitle:""}),a=V({studentId:"",consumeType:"",amount:0,description:""}),U=V({studentId:[{required:!0,message:"请输入学生ID",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],consumeType:[{required:!0,message:"请选择消费类型",trigger:"change"}],amount:[{required:!0,message:"请输入消费金额",trigger:"blur"},{type:"number",min:.01,message:"金额必须大于0",trigger:"blur"}],description:[{max:200,message:"描述不能超过200个字符",trigger:"blur"}]}),k=async()=>{if(a.studentId)try{const s=await N.getCardByStudentId(a.studentId);o.value=s,s.status!=="ACTIVE"&&(f.warning("该校园卡已注销，无法进行消费"),o.value=null)}catch(s){o.value=null,f.error(s.message||"获取校园卡信息失败")}},B=async s=>{s&&await s.validate(async e=>{if(e){if(!o.value){f.warning("请先输入有效的学生ID");return}if(a.amount>o.value.balance){f.warning("余额不足");return}try{b.value=!0;const d=await N.updateBalance(a.studentId,-a.amount);r.success=!0,r.title="消费成功",r.subTitle=`已成功从学生ID为 ${a.studentId} 的校园卡扣除 ¥${a.amount}`,m.value=!0,I(s),o.value=null}catch(d){r.success=!1,r.title="消费失败",r.subTitle=d.message||"请检查卡片状态或余额是否充足",m.value=!0}finally{b.value=!1}}})},I=s=>{s&&(s.resetFields(),o.value=null)};return(s,e)=>{const d=u("el-input"),i=u("el-form-item"),p=u("el-option"),E=u("el-select"),R=u("el-input-number"),C=u("el-icon"),g=u("el-button"),D=u("el-form"),F=u("el-card"),$=u("el-result"),A=u("el-dialog");return T(),x("div",H,[l(F,{class:"card-container"},{header:t(()=>e[10]||(e[10]=[y("div",{class:"card-header"},[y("h3",null,"校园卡消费")],-1)])),default:t(()=>[l(D,{ref_key:"formRef",ref:v,model:a,rules:U,"label-width":"120px","label-position":"right","status-icon":""},{default:t(()=>[l(i,{label:"学生ID",prop:"studentId"},{default:t(()=>[l(d,{modelValue:a.studentId,"onUpdate:modelValue":e[0]||(e[0]=n=>a.studentId=n),placeholder:"请输入学生ID",clearable:"",onBlur:k},null,8,["modelValue"])]),_:1}),o.value?(T(),x(q,{key:0},[l(i,{label:"学生姓名"},{default:t(()=>[l(d,{modelValue:o.value.studentName,"onUpdate:modelValue":e[1]||(e[1]=n=>o.value.studentName=n),disabled:""},null,8,["modelValue"])]),_:1}),l(i,{label:"当前余额"},{default:t(()=>[l(d,{modelValue:o.value.balance,"onUpdate:modelValue":e[2]||(e[2]=n=>o.value.balance=n),disabled:""},{prepend:t(()=>e[11]||(e[11]=[_("¥")])),_:1},8,["modelValue"])]),_:1})],64)):S("",!0),l(i,{label:"消费类型",prop:"consumeType"},{default:t(()=>[l(E,{modelValue:a.consumeType,"onUpdate:modelValue":e[3]||(e[3]=n=>a.consumeType=n),placeholder:"请选择消费类型",style:{width:"100%"}},{default:t(()=>[l(p,{label:"食堂就餐",value:"CANTEEN"}),l(p,{label:"超市购物",value:"SUPERMARKET"}),l(p,{label:"图书文具",value:"BOOKSTORE"}),l(p,{label:"其他",value:"OTHER"})]),_:1},8,["modelValue"])]),_:1}),l(i,{label:"消费金额",prop:"amount"},{default:t(()=>[l(R,{modelValue:a.amount,"onUpdate:modelValue":e[4]||(e[4]=n=>a.amount=n),min:.01,max:o.value?o.value.balance:9999,precision:2,step:1,style:{width:"100%"}},null,8,["modelValue","max"])]),_:1}),l(i,{label:"消费说明",prop:"description"},{default:t(()=>[l(d,{modelValue:a.description,"onUpdate:modelValue":e[5]||(e[5]=n=>a.description=n),type:"textarea",rows:2,placeholder:"请输入消费说明（选填）"},null,8,["modelValue"])]),_:1}),l(i,null,{default:t(()=>[l(g,{type:"primary",onClick:e[6]||(e[6]=n=>B(v.value)),loading:b.value},{default:t(()=>[l(C,null,{default:t(()=>[l(w(K))]),_:1}),e[12]||(e[12]=_("确认消费 "))]),_:1,__:[12]},8,["loading"]),l(g,{onClick:e[7]||(e[7]=n=>I(v.value))},{default:t(()=>[l(C,null,{default:t(()=>[l(w(M))]),_:1}),e[13]||(e[13]=_("重置 "))]),_:1,__:[13]})]),_:1})]),_:1},8,["model","rules"])]),_:1}),l(A,{modelValue:m.value,"onUpdate:modelValue":e[9]||(e[9]=n=>m.value=n),title:"消费结果",width:"30%",center:""},{default:t(()=>[y("div",P,[l($,{icon:r.success?"success":"error",title:r.title,"sub-title":r.subTitle},{extra:t(()=>[l(g,{type:"primary",onClick:e[8]||(e[8]=n=>m.value=!1)},{default:t(()=>e[14]||(e[14]=[_("确定")])),_:1,__:[14]})]),_:1},8,["icon","title","sub-title"])])]),_:1},8,["modelValue"])])}}},L=O(j,[["__scopeId","data-v-6387d0f0"]]);export{L as default};
