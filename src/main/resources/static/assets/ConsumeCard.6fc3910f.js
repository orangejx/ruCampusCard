import{_ as q,r as _,h as V,a as d,o as x,c as C,b as l,w as t,e as y,F as A,i as f,l as K,d as w,E as c,f as M,x as S}from"./index.5bfda754.js";import{a as $}from"./axios.3a665b0f.js";const H={class:"consume-card"},P={class:"result-content"},j={__name:"ConsumeCard",setup(z){const v=_(null),g=_(!1),p=_(!1),s=_(null),u=V({success:!1,title:"",subTitle:""}),a=V({studentId:"",consumeType:"",amount:0,description:""}),N=V({studentId:[{required:!0,message:"请输入学生ID",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],consumeType:[{required:!0,message:"请选择消费类型",trigger:"change"}],amount:[{required:!0,message:"请输入消费金额",trigger:"blur"},{type:"number",min:.01,message:"金额必须大于0",trigger:"blur"}],description:[{max:200,message:"描述不能超过200个字符",trigger:"blur"}]}),U=async()=>{var i,e;if(a.studentId)try{const o=await $.get(`/api/v1/cards/student/${a.studentId}`);o.data.code===200?o.data.data?(s.value=o.data.data,s.value.status==="INACTIVE"&&(c.warning("该校园卡已注销，无法进行消费"),s.value=null)):(s.value=null,c.warning("未找到校园卡信息")):(s.value=null,c.error(o.data.msg||"获取校园卡信息失败"))}catch(o){s.value=null,c.error(((e=(i=o.response)==null?void 0:i.data)==null?void 0:e.msg)||o.message||"获取校园卡信息失败")}},k=async i=>{i&&await i.validate(async e=>{var o,m;if(e){if(!s.value){c.warning("请先输入有效的学生ID");return}if(a.amount>s.value.balance){c.warning("余额不足");return}try{g.value=!0;const r=await $.put(`/api/v1/cards/student/${a.studentId}/balance`,{amount:-a.amount,type:a.consumeType,description:a.description});r.data.code===200?(u.success=!0,u.title="消费成功",u.subTitle=`已成功从学生ID为 ${a.studentId} 的校园卡扣除 ¥${a.amount}，${r.data.msg}`,p.value=!0,I(i),s.value=null):(u.success=!1,u.title="消费失败",u.subTitle=r.data.msg||"请检查卡片状态或余额是否充足",p.value=!0)}catch(r){u.success=!1,u.title="消费失败",u.subTitle=((m=(o=r.response)==null?void 0:o.data)==null?void 0:m.msg)||r.message||"请检查卡片状态或余额是否充足",p.value=!0}finally{g.value=!1}}})},I=i=>{i&&(i.resetFields(),s.value=null)};return(i,e)=>{const o=d("el-input"),m=d("el-form-item"),r=d("el-option"),E=d("el-select"),R=d("el-input-number"),T=d("el-icon"),b=d("el-button"),B=d("el-form"),D=d("el-card"),F=d("el-result"),O=d("el-dialog");return x(),C("div",H,[l(D,{class:"card-container"},{header:t(()=>e[10]||(e[10]=[y("div",{class:"card-header"},[y("h3",null,"校园卡消费")],-1)])),default:t(()=>[l(B,{ref_key:"formRef",ref:v,model:a,rules:N,"label-width":"120px","label-position":"right","status-icon":""},{default:t(()=>[l(m,{label:"学生ID",prop:"studentId"},{default:t(()=>[l(o,{modelValue:a.studentId,"onUpdate:modelValue":e[0]||(e[0]=n=>a.studentId=n),placeholder:"请输入学生ID",clearable:"",onBlur:U},null,8,["modelValue"])]),_:1}),s.value?(x(),C(A,{key:0},[l(m,{label:"学生姓名"},{default:t(()=>[l(o,{modelValue:s.value.studentName,"onUpdate:modelValue":e[1]||(e[1]=n=>s.value.studentName=n),disabled:""},null,8,["modelValue"])]),_:1}),l(m,{label:"当前余额"},{default:t(()=>[l(o,{modelValue:s.value.balance,"onUpdate:modelValue":e[2]||(e[2]=n=>s.value.balance=n),disabled:""},{prepend:t(()=>e[11]||(e[11]=[f("¥")])),_:1},8,["modelValue"])]),_:1})],64)):K("",!0),l(m,{label:"消费类型",prop:"consumeType"},{default:t(()=>[l(E,{modelValue:a.consumeType,"onUpdate:modelValue":e[3]||(e[3]=n=>a.consumeType=n),placeholder:"请选择消费类型",style:{width:"100%"}},{default:t(()=>[l(r,{label:"食堂就餐",value:"CANTEEN"}),l(r,{label:"超市购物",value:"SUPERMARKET"}),l(r,{label:"图书文具",value:"BOOKSTORE"}),l(r,{label:"其他",value:"OTHER"})]),_:1},8,["modelValue"])]),_:1}),l(m,{label:"消费金额",prop:"amount"},{default:t(()=>[l(R,{modelValue:a.amount,"onUpdate:modelValue":e[4]||(e[4]=n=>a.amount=n),min:.01,max:s.value?s.value.balance:9999,precision:2,step:1,style:{width:"100%"}},null,8,["modelValue","max"])]),_:1}),l(m,{label:"消费说明",prop:"description"},{default:t(()=>[l(o,{modelValue:a.description,"onUpdate:modelValue":e[5]||(e[5]=n=>a.description=n),type:"textarea",rows:2,placeholder:"请输入消费说明（选填）"},null,8,["modelValue"])]),_:1}),l(m,null,{default:t(()=>[l(b,{type:"primary",onClick:e[6]||(e[6]=n=>k(v.value)),loading:g.value},{default:t(()=>[l(T,null,{default:t(()=>[l(w(M))]),_:1}),e[12]||(e[12]=f("确认消费 "))]),_:1,__:[12]},8,["loading"]),l(b,{onClick:e[7]||(e[7]=n=>I(v.value))},{default:t(()=>[l(T,null,{default:t(()=>[l(w(S))]),_:1}),e[13]||(e[13]=f("重置 "))]),_:1,__:[13]})]),_:1})]),_:1},8,["model","rules"])]),_:1}),l(O,{modelValue:p.value,"onUpdate:modelValue":e[9]||(e[9]=n=>p.value=n),title:"消费结果",width:"30%",center:""},{default:t(()=>[y("div",P,[l(F,{icon:u.success?"success":"error",title:u.title,"sub-title":u.subTitle},{extra:t(()=>[l(b,{type:"primary",onClick:e[8]||(e[8]=n=>p.value=!1)},{default:t(()=>e[14]||(e[14]=[f("确定")])),_:1,__:[14]})]),_:1},8,["icon","title","sub-title"])])]),_:1},8,["modelValue"])])}}},L=q(j,[["__scopeId","data-v-8ce13568"]]);export{L as default};
