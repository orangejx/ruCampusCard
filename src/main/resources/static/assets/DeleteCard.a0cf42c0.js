import{_ as S,r as v,h as I,a as d,o as w,c as C,b as t,w as l,e as m,F as j,i as p,t as z,l as G,d as T,E as c,g as H,x as J}from"./index.5bfda754.js";import{a as D}from"./axios.3a665b0f.js";const K={class:"delete-card"},L={class:"warning-box"},O={class:"result-content"},P={__name:"DeleteCard",setup(Q){const g=v(null),b=v(!1),_=v(!1),a=v(null),o=I({success:!1,title:"",subTitle:""}),r=I({studentId:"",reason:"",confirmation:!1}),$=I({studentId:[{required:!0,message:"请输入学生ID",trigger:"blur"},{min:3,max:20,message:"长度在 3 到 20 个字符",trigger:"blur"}],reason:[{required:!0,message:"请输入注销原因",trigger:"blur"},{min:5,max:200,message:"长度在 5 到 200 个字符",trigger:"blur"}],confirmation:[{validator:(i,e,s)=>{e?s():s(new Error("请确认注销操作"))},trigger:"change"}]}),k=async()=>{var i,e;if(r.studentId)try{const s=await D.get(`/api/v1/cards/student/${r.studentId}`);s.data.code===200?s.data.data?(a.value=s.data.data,a.value.status==="INACTIVE"?c.warning("该校园卡已经被注销"):a.value.balance>0&&c.warning("该卡还有余额，建议先处理余额后再注销")):(a.value=null,c.warning("未找到校园卡信息")):(a.value=null,c.error(s.data.msg||"获取校园卡信息失败"))}catch(s){a.value=null,c.error(((e=(i=s.response)==null?void 0:i.data)==null?void 0:e.msg)||s.message||"获取校园卡信息失败")}},E=async i=>{i&&await i.validate(async e=>{var s,f;if(e){if(!a.value){c.warning("请先输入有效的学生ID");return}if(a.value.status!=="ACTIVE"){c.warning("该校园卡已经被注销");return}try{b.value=!0;const n=await D.delete(`/api/v1/cards/student/${r.studentId}`,{data:{reason:r.reason}});n.data.code===200?(o.success=!0,o.title="注销成功",o.subTitle=`学生ID为 ${r.studentId} 的校园卡已成功注销。${n.data.msg}`,_.value=!0):(o.success=!1,o.title="注销失败",o.subTitle=n.data.msg||"注销过程中发生错误",_.value=!0)}catch(n){o.success=!1,o.title="注销失败",o.subTitle=((f=(s=n.response)==null?void 0:s.data)==null?void 0:f.msg)||n.message||"注销过程中发生错误",_.value=!0}finally{b.value=!1}}})},x=i=>{i&&(i.resetFields(),a.value=null)},N=()=>{_.value=!1,o.success&&x(g.value)};return(i,e)=>{const s=d("el-alert"),f=d("el-input"),n=d("el-form-item"),U=d("el-tag"),A=d("el-checkbox"),y=d("el-icon"),V=d("el-button"),F=d("el-popconfirm"),B=d("el-form"),q=d("el-card"),R=d("el-result"),M=d("el-dialog");return w(),C("div",K,[t(q,{class:"card-container"},{header:l(()=>e[8]||(e[8]=[m("div",{class:"card-header"},[m("h3",null,"校园卡注销")],-1)])),default:l(()=>[m("div",L,[t(s,{title:"注意：校园卡注销后将无法恢复，请谨慎操作！",type:"warning",closable:!1,"show-icon":""},{default:l(()=>e[9]||(e[9]=[m("p",null,"注销前请确保：",-1),m("ol",null,[m("li",null,"已确认该卡片不再使用"),m("li",null,"已处理卡内剩余余额"),m("li",null,"已完成所有待处理的交易")],-1)])),_:1,__:[9]})]),t(B,{ref_key:"formRef",ref:g,model:r,rules:$,"label-width":"120px","label-position":"right","status-icon":""},{default:l(()=>[t(n,{label:"学生ID",prop:"studentId"},{default:l(()=>[t(f,{modelValue:r.studentId,"onUpdate:modelValue":e[0]||(e[0]=u=>r.studentId=u),placeholder:"请输入要注销的学生ID",clearable:"",onBlur:k},null,8,["modelValue"])]),_:1}),a.value?(w(),C(j,{key:0},[t(n,{label:"学生姓名"},{default:l(()=>[t(f,{modelValue:a.value.studentName,"onUpdate:modelValue":e[1]||(e[1]=u=>a.value.studentName=u),disabled:""},null,8,["modelValue"])]),_:1}),t(n,{label:"当前余额"},{default:l(()=>[t(f,{modelValue:a.value.balance,"onUpdate:modelValue":e[2]||(e[2]=u=>a.value.balance=u),disabled:""},{prepend:l(()=>e[10]||(e[10]=[p("¥")])),_:1},8,["modelValue"])]),_:1}),t(n,{label:"卡片状态"},{default:l(()=>[t(U,{type:a.value.status==="ACTIVE"?"success":"danger"},{default:l(()=>[p(z(a.value.status==="ACTIVE"?"正常":"已注销"),1)]),_:1},8,["type"])]),_:1})],64)):G("",!0),t(n,{label:"注销原因",prop:"reason"},{default:l(()=>[t(f,{modelValue:r.reason,"onUpdate:modelValue":e[3]||(e[3]=u=>r.reason=u),type:"textarea",rows:3,placeholder:"请输入注销原因"},null,8,["modelValue"])]),_:1}),t(n,{label:"确认注销",prop:"confirmation"},{default:l(()=>[t(A,{modelValue:r.confirmation,"onUpdate:modelValue":e[4]||(e[4]=u=>r.confirmation=u)},{default:l(()=>e[11]||(e[11]=[p(" 我已了解注销后果，确认要注销此校园卡 ")])),_:1,__:[11]},8,["modelValue"])]),_:1}),t(n,null,{default:l(()=>[t(F,{title:"确定要注销这张校园卡吗？","confirm-button-text":"确定注销","cancel-button-text":"再想想",onConfirm:e[5]||(e[5]=u=>E(g.value))},{reference:l(()=>[t(V,{type:"danger",disabled:!r.confirmation||!a.value||a.value.status!=="ACTIVE",loading:b.value},{default:l(()=>[t(y,null,{default:l(()=>[t(T(H))]),_:1}),e[12]||(e[12]=p("注销校园卡 "))]),_:1,__:[12]},8,["disabled","loading"])]),_:1}),t(V,{onClick:e[6]||(e[6]=u=>x(g.value))},{default:l(()=>[t(y,null,{default:l(()=>[t(T(J))]),_:1}),e[13]||(e[13]=p("重置 "))]),_:1,__:[13]})]),_:1})]),_:1},8,["model","rules"])]),_:1}),t(M,{modelValue:_.value,"onUpdate:modelValue":e[7]||(e[7]=u=>_.value=u),title:"注销结果",width:"30%",center:""},{default:l(()=>[m("div",O,[t(R,{icon:o.success?"success":"error",title:o.title,"sub-title":o.subTitle},{extra:l(()=>[t(V,{type:"primary",onClick:N},{default:l(()=>e[14]||(e[14]=[p("确定")])),_:1,__:[14]})]),_:1},8,["icon","title","sub-title"])])]),_:1},8,["modelValue"])])}}},Y=S(P,[["__scopeId","data-v-87207378"]]);export{Y as default};
